!function () {
    "use strict";
    var manager = tinymce.util.Tools.resolve("tinymce.PluginManager");

    manager.add("charcount", function (editor) {
        var id = editor.id;


        editor.on('init', function () {
            var textarea = $('#' + id);
            var maxlength = parseInt(textarea.attr('maxlength'));
            var statusbar = editor.theme.panel && editor.theme.panel.find("#statusbar")[0];

            var decodeEntities = function (str) {
                var textArea = document.createElement('textarea');
                textArea.innerHTML = str;
                return textArea.value;
            };
            var getCount = function () {
                var t = editor.getContent({format: "raw"});
                console.log(t);
                t = decodeEntities(t.replace(/<[^>]+>/ig, ""));
                console.log(t);
                return t.length;
            };

            statusbar.insert({
                type: "label",
                name: "charcount",
                text: ["Chars: {0}", getCount()],
                classes: "wordcount",
                disabled: editor.settings.readonly
            }, 0);

            editor.on('keyup', function () {
                editor.theme.panel.find("#charcount").text(["Chars: {0}", getCount()]);
            });
        });
    });
}();